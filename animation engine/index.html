<!DOCTYPE html>
<html>
 
<head>
  <meta charset="UTF-8" />
  <title>Autodesk Forge Fragment Controls Dashboard</title>
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" />
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }
 
    #viewer {
      width: 100vw;
      height: 100vh;
    }
 
    #dashboard {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.97);
      padding: 16px;
      border-radius: 8px;
      width: 270px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      font-family: Arial, sans-serif;
    }
 
    #dashboard h2 {
      margin-top: 0;
      font-size: 1.2em;
      margin-bottom: 10px;
    }
 
    .section {
      margin-bottom: 18px;
    }
 
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
    }
 
    button,
    select,
    input[type="number"],
    input[type="color"] {
      margin: 4px 0 8px 0;
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      font-size: 1em;
    }
 
    .row {
      display: flex;
      gap: 6px;
    }
 
    .row>* {
      flex: 1;
    }
  </style>
</head>
 
<body>
  <div id="viewer"></div>
  <div id="dashboard">
    <h2>Fragment Controls Dashboard</h2>
    <div class="section">
      <button onclick="logModelTree()">Log Model Tree & Fragments</button>
      <button onclick="colorAllFragments()">Color All Fragments Randomly</button>
    </div>
    <div class="section">
      <label for="fragmentSelect">Select Fragment</label>
      <select id="fragmentSelect">
        <option disabled selected>-- Select Fragment --</option>
      </select>
      <button onclick="colorSelectedFragment()">Color Selected Fragment (Random)</button>
      <div class="row">
        <input type="color" id="customColor" value="#ff0000" title="Pick a color">
        <button onclick="colorSelectedFragmentCustom()">Set Custom Color</button>
      </div>
    </div>
    <div class="section">
      <label>Scale Fragment</label>
      <div class="row">
        <input type="number" id="scaleFactor" value="1.5" min="0.1" step="0.1" title="Scale factor">
        <button onclick="scaleSelectedFragment()">Scale</button>
      </div>
    </div>
    <div class="section">
      <label>Rotate Fragment (degrees)</label>
      <div class="row">
        <input type="number" id="rotateAngle" value="45" step="1" title="Degrees">
        <select id="rotateAxis">
          <option value="x">X</option>
          <option value="y">Y</option>
          <option value="z" selected>Z</option>
        </select>
        <button onclick="rotateSelectedFragment()">Rotate</button>
      </div>
    </div>
    <div class="section">
      <label>Translate Fragment</label>
      <div class="row">
        <input type="number" id="translateX" value="10" step="1" title="X">
        <input type="number" id="translateY" value="0" step="1" title="Y">
        <input type="number" id="translateZ" value="0" step="1" title="Z">
        <button onclick="translateSelectedFragment()">Move</button>
      </div>
    </div>
  </div>
  <script>
    const options = {
      env: 'AutodeskProduction',
      accessToken: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IlhrUFpfSmhoXzlTYzNZS01oRERBZFBWeFowOF9SUzI1NiIsInBpLmF0bSI6ImFzc2MifQ.eyJzY29wZSI6WyJkYXRhOndyaXRlIiwiZGF0YTpyZWFkIiwiYnVja2V0OmNyZWF0ZSIsImJ1Y2tldDpkZWxldGUiXSwiY2xpZW50X2lkIjoiV0EyS3o5MXhWVWZBcElHWW15aDh2QUYzWVVsQ1FvcUJXeTlIdWs5ejJSTG1wQjliIiwiaXNzIjoiaHR0cHM6Ly9kZXZlbG9wZXIuYXBpLmF1dG9kZXNrLmNvbSIsImF1ZCI6Imh0dHBzOi8vYXV0b2Rlc2suY29tIiwianRpIjoiZ3JoUTRJcUhFbkFxMHJvZTNZcnNjOWo1MHBTUjVDTjRxUHZidTNoRG14cDB4UHo5aVlqbjJzRUJwVU9UNEVXSyIsImV4cCI6MTc0ODM1NTYzNX0.bFRIzaEjP2lTtBzOoBXEt27k4aHmx1dIaggx4K8tRALOAYeUEL7GXd7hab2tP0r6N32LGk6KlA-oUWU5QvCiHz4a-gwE4RMbNGK-kDl76ILwXSSHV1nN69RqZ750NCTQZpG7yNNb2SUs_AfsOidLdUFZagB4oOSFMLEC0FLA78kHUt_XfzDrjF2_pVXcxFsiT8ID7j0XJEJliE8-oexC7TyclZhliqw0ztMWwUblIWdxC3kHkwbzZ6G3VqfQifeUhBWKGZI7RAPscS5PSlvMBwAPfoDVNUDRbApjsGJuCTOLWokW64iNt6g18vPzXSjCoDpfGqRU9VCghKBTcYdO3w'
    };
    const documentId = 'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6Y2hlY2stM2J1Y2tldC9zY2lzc29ycy5pYW0';
    let viewer;
    let fragmentToDbIdMap = {};
 
    Autodesk.Viewing.Initializer(options, () => {
      viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById('viewer'));
      viewer.start();
      Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
    });
 
    function onDocumentLoadSuccess(doc) {
      const viewable = doc.getRoot().getDefaultGeometry();
      viewer.loadDocumentNode(doc, viewable).then(() => {
        console.log("Model loaded.");
        viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, () => {
          console.log("Geometry loaded.");
          populateFragmentDropdown();
        });
      });
    }
 
    function onDocumentLoadFailure(code, message) {
      console.error(`Could not load document (${code}): ${message}`);
    }
 
    function logModelTree() {
      const tree = viewer.model.getInstanceTree();
      if (!tree) {
        console.error("Instance tree not loaded.");
        return;
      }
      tree.enumNodeChildren(tree.getRootId(), function (dbId) {
        const name = tree.getNodeName(dbId);
        console.log(`Node: ${dbId} - ${name}`);
        tree.enumNodeFragments(dbId, function (fragId) {
          console.log(`  Fragment ID: ${fragId}`);
        });
      }, true);
    }
 
    function colorAllFragments() {
      const tree = viewer.model.getInstanceTree();
      if (!tree) {
        console.error("Instance tree not loaded.");
        return;
      }
      tree.enumNodeChildren(tree.getRootId(), function (dbId) {
        const color = new THREE.Vector4(Math.random(), Math.random(), Math.random(), 1);
        viewer.setThemingColor(dbId, color);
      }, true);
      viewer.impl.invalidate(true);
    }
 
    function populateFragmentDropdown() {
      const tree = viewer.model.getInstanceTree();
      if (!tree) {
        console.error("Instance tree not loaded.");
        return;
      }
      const dropdown = document.getElementById("fragmentSelect");
      dropdown.innerHTML = '<option disabled selected>-- Select Fragment --</option>';
      fragmentToDbIdMap = {};
      tree.enumNodeChildren(tree.getRootId(), function (dbId) {
        const name = tree.getNodeName(dbId);
        tree.enumNodeFragments(dbId, function (fragId) {
          fragmentToDbIdMap[fragId] = dbId;
          const option = document.createElement("option");
          option.value = fragId;
          option.textContent = `Fragment ${fragId} → dbId ${dbId} (${name})`;
          dropdown.appendChild(option);
        });
      }, true);
    }
 
    function colorSelectedFragment() {
      const fragId = document.getElementById("fragmentSelect").value;
      const dbId = fragmentToDbIdMap[fragId];
      if (!dbId) {
        alert("Please select a valid fragment.");
        return;
      }
      const color = new THREE.Vector4(Math.random(), Math.random(), Math.random(), 1);
      viewer.setThemingColor(parseInt(dbId), color);
      viewer.impl.invalidate(true);
      console.log(`Fragment ${fragId} → dbId ${dbId} colored.`);
    }
 
    function colorSelectedFragmentCustom() {
      const fragId = document.getElementById("fragmentSelect").value;
      const dbId = fragmentToDbIdMap[fragId];
      if (!dbId) {
        alert("Please select a valid fragment.");
        return;
      }
      const hex = document.getElementById("customColor").value;
      // Convert hex to normalized RGB
      const r = parseInt(hex.substr(1, 2), 16) / 255;
      const g = parseInt(hex.substr(3, 2), 16) / 255;
      const b = parseInt(hex.substr(5, 2), 16) / 255;
      const color = new THREE.Vector4(r, g, b, 1);
      viewer.setThemingColor(parseInt(dbId), color);
      viewer.impl.invalidate(true);
      console.log(`Fragment ${fragId} → dbId ${dbId} colored with custom color.`);
    }
 
    function scaleSelectedFragment() {
      const fragId = document.getElementById("fragmentSelect").value;
      const dbId = fragmentToDbIdMap[fragId];
      if (!dbId) {
        alert("Please select a valid fragment.");
        return;
      }
      const factor = parseFloat(document.getElementById("scaleFactor").value) || 1.5;
      const model = viewer.model;
      const fragProxy = viewer.impl.getFragmentProxy(model, parseInt(fragId));
      if (!fragProxy) {
        alert("Could not get fragment proxy.");
        return;
      }
      fragProxy.getAnimTransform();
      fragProxy.scale.x *= factor;
      fragProxy.scale.y *= factor;
      fragProxy.scale.z *= factor;
      fragProxy.updateAnimTransform();
      viewer.impl.invalidate(true);
      console.log(`Fragment ${fragId} scaled by ${factor}x.`);
    }
 
    function rotateSelectedFragment() {
      const fragId = document.getElementById("fragmentSelect").value;
      const dbId = fragmentToDbIdMap[fragId];
      if (!dbId) {
        alert("Please select a valid fragment.");
        return;
      }
      const angleDeg = parseFloat(document.getElementById("rotateAngle").value) || 45;
      const axisVal = document.getElementById("rotateAxis").value;
      let axis;
      if (axisVal === "x") axis = new THREE.Vector3(1, 0, 0);
      else if (axisVal === "y") axis = new THREE.Vector3(0, 1, 0);
      else axis = new THREE.Vector3(0, 0, 1);
      const angleRad = angleDeg * Math.PI / 180;
      const model = viewer.model;
      const fragProxy = viewer.impl.getFragmentProxy(model, parseInt(fragId));
      if (!fragProxy) {
        alert("Could not get fragment proxy.");
        return;
      }
      fragProxy.getAnimTransform();
      const q = new THREE.Quaternion();
      q.setFromAxisAngle(axis, angleRad);
      fragProxy.quaternion.multiplyQuaternions(q, fragProxy.quaternion);
      fragProxy.updateAnimTransform();
      viewer.impl.invalidate(true);
      console.log(`Fragment ${fragId} rotated ${angleDeg}° around ${axisVal.toUpperCase()} axis.`);
    }
 
    function translateSelectedFragment() {
      const fragId = document.getElementById("fragmentSelect").value;
      const dbId = fragmentToDbIdMap[fragId];
      if (!dbId) {
        alert("Please select a valid fragment.");
        return;
      }
      const dx = parseFloat(document.getElementById("translateX").value) || 0;
      const dy = parseFloat(document.getElementById("translateY").value) || 0;
      const dz = parseFloat(document.getElementById("translateZ").value) || 0;
      const model = viewer.model;
      const fragProxy = viewer.impl.getFragmentProxy(model, parseInt(fragId));
      if (!fragProxy) {
        alert("Could not get fragment proxy.");
        return;
      }
      fragProxy.getAnimTransform();
      fragProxy.position.x += dx;
      fragProxy.position.y += dy;
      fragProxy.position.z += dz;
      fragProxy.updateAnimTransform();
      viewer.impl.invalidate(true);
      console.log(`Fragment ${fragId} translated by (${dx}, ${dy}, ${dz}).`);
    }
  </script>
</body>
 
</html>